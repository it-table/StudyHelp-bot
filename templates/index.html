<!DOCTYPE html>
<html lang="ru">
<head>
  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="stylesheet" href="/static/modal.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>StudyHelp</title>
</head>
<body>
<div class="container-fluid">
  <div class="background"></div>
  <header>
    <div class="logo"><span>S</span></div>
    <section class="header-content">
      <h1>StudyHelp</h1>
      <p>StudyHelp ‚Äî —Ç–≤–æ–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É—á–µ–±–µ. –ü–æ–º–æ–∂–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –¥–æ–º–∞—à–∫–æ–π, –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –ø–µ—Ä–µ—Å–¥–∞—á–µ –∏ –ø–æ–Ω—è—Ç—å –ª—é–±—É—é —Ç–µ–º—É. –û—Ç —Å—Ç—Ä–µ—Å—Å–∞ ‚Äî –∫ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ ¬´–ø—è—Ç—å¬ª!</p>

      <div class="buttons-container">
        <button class="tg-button primary" onclick="openBookingModal()">–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑</button>
        <button class="tg-button history" onclick="openHistoryModal()">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</button>
        <button class="tg-button secondary" onclick="openAboutModal()">–û –Ω–∞—Å</button>
      </div>
    </section>
  </header>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ -->
<div id="historyModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <button class="close-modal" onclick="closeHistoryModal()">&times;</button>
    <h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
    <div id="bookingsList" class="bookings-list">
      <div class="loading-spinner"></div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–∏—Ö –∑–∞–ø–∏—Å–µ–π...</p>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <button class="close-modal" onclick="closeEditModal()">&times;</button>
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
    <form id="editForm">
      <input type="hidden" id="editBookingId">
      <input type="hidden" id="editOriginalTime">

      <div class="form-group">
        <label for="editSubject">–ü—Ä–µ–¥–º–µ—Ç –ø–æ–º–æ—â–∏:</label>
        <input type="text" id="editSubject" required>
      </div>

      <div class="form-group">
        <label for="editService">–¢–∏–ø —É—Å–ª—É–≥–∏:</label>
        <select id="editService" required>
    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É --</option>
    <option value="–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</option>
    <option value="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è/–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è/–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</option>
    <option value="–≠–∫–∑–∞–º–µ–Ω">–≠–∫–∑–∞–º–µ–Ω</option>
    <option value="–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</option>
    <option value="–†–µ—Ñ–µ—Ä–∞—Ç/–ö—É—Ä—Å–æ–≤–∞—è">–†–µ—Ñ–µ—Ä–∞—Ç/–ö—É—Ä—Å–æ–≤–∞—è</option>
  </select>
      </div>

      <div class="form-group">
        <label for="editDate">–î–∞—Ç–∞:</label>
        <input type="date" id="editDate" required>
      </div>

      <div class="form-group">
    <label for="editTimeInput">–í—Ä–µ–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:</label>
    <input type="text" id="editTimeInput" required>
    <div id="editTimeValidationMessage" class="validation-error"></div>
    <small>–§–æ—Ä–º–∞—Ç: –ß–ß:MM (–Ω–∞–ø—Ä–∏–º–µ—Ä, 09:00, 14:30, 18:00)</small>
</div>

      <div class="form-group">
        <label for="editComment">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è:</label>
        <textarea id="editComment"></textarea>
      </div>

      <div class="edit-buttons">
        <button type="submit" class="submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button type="button" class="cancel-btn" onclick="triggerCancelFromEdit()">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–û –Ω–∞—Å" -->
<div id="aboutModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <button class="close-modal" onclick="closeAboutModal()">&times;</button>
    <h2>–û –Ω–∞—Å</h2>
    <div class="about-content">
      <p>üéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</p>
      <p>–ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥—ë—Ç–µ –Ω–∞–¥—ë–∂–Ω—É—é –ø–æ–º–æ—â—å –≤ —É—á—ë–±–µ ‚Äî –æ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –¥–æ –∫—É—Ä—Å–æ–≤—ã—Ö –∏ –¥–∏–ø–ª–æ–º–æ–≤.</p>

      <p>üìå –ü–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç –Ω–∞—Å:</p>
      <ul>
        <li>–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ –∏ –≤—É–∑–∞–º–∏.</li>
        <li>–í—ã—Å–æ–∫–∏–µ –æ—Ü–µ–Ω–∫–∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π.</li>
        <li>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–∫–∞–∑—É.</li>
      </ul>

      <p>–ú—ã –¥–µ–ª–∞–µ–º –≤—Å—ë –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –≤ —Å—Ä–æ–∫, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –∏ –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω—ã –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.</p>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="bookingModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()">&times;</button>
    <h2>–ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É</h2>
    <form id="bookingForm">
      <div class="form-group">
        <label for="subject">–ü—Ä–µ–¥–º–µ—Ç –ø–æ–º–æ—â–∏:</label>
        <input type="text" id="subject" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç.–∞–Ω–∞–ª–∏–∑, –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ..." required>
      </div>

      <div class="form-group select-group">
        <label for="service">–¢–∏–ø —É—Å–ª—É–≥–∏:</label>
        <select id="service" required>
  <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É --</option>
  <option value="–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</option>
  <option value="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è/–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è/–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</option>
  <option value="–≠–∫–∑–∞–º–µ–Ω">–≠–∫–∑–∞–º–µ–Ω</option>
  <option value="–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</option>
  <option value="–†–µ—Ñ–µ—Ä–∞—Ç/–ö—É—Ä—Å–æ–≤–∞—è">–†–µ—Ñ–µ—Ä–∞—Ç/–ö—É—Ä—Å–æ–≤–∞—è</option>
</select>

      </div>

      <div class="form-group">
        <label for="date">–î–∞—Ç–∞:</label>
        <input type="date" id="date" required>
      </div>

      <div class="form-group">
          <label for="timeInput">–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:</label>
          <input type="text" id="timeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 14:30" required
                 pattern="[0-9]{2}:[0-9]{2}">
          <div id="timeValidationMessage" class="validation-error"></div>
          <small>–§–æ—Ä–º–∞—Ç: –ß–ß:MM (–Ω–∞–ø—Ä–∏–º–µ—Ä, 09:00, 14:30, 18:00)</small>
      </div>

      <div class="form-group">
        <label for="comment">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è:</label>
        <textarea id="comment" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∑–∞–¥–∞—á—É, —Ç–µ–º—É –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã..."></textarea>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
    </form>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// Telegram WebApp initialization
let tg = window.Telegram.WebApp;
let isModalOpen = false;
let userBookings = [];
let selectedBookingId = null;
let pendingCancelId = null;

tg.expand();
tg.enableClosingConfirmation();

// handle popup result (confirm/cancel)
tg.onEvent('popupClosed', function(e) {
    if (e && e.button_id === 'confirm_cancel' && pendingCancelId) {
        const user = getUserData();
        if (!user.id) {
            tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.");
            pendingCancelId = null;
            return;
        }
        cancelBookingDirect(pendingCancelId, user.id);
        pendingCancelId = null;
    }
});

// Modal functions
function openBookingModal() {
    closeHistoryModal();
    closeEditModal();

    const modal = document.getElementById('bookingModal');
    modal.classList.add('show');
    isModalOpen = true;
    document.body.style.overflow = 'hidden';

    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('date');
    dateInput.min = today;
    dateInput.value = '';

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏
    const timeInput = document.getElementById('timeInput');
    timeInput.value = '';
    timeInput.classList.remove('input-error', 'input-success');
    document.getElementById('timeValidationMessage').textContent = '';

    clearValidation();
}

function closeModal() {
    const modal = document.getElementById('bookingModal');
    modal.classList.remove('show');
    isModalOpen = false;
    document.body.style.overflow = '';
}

function openAboutModal() {
    closeModal();
    closeHistoryModal();
    closeEditModal();

    const modal = document.getElementById('aboutModal');
    modal.classList.add('show');
    isModalOpen = true;
    document.body.style.overflow = 'hidden';
}

function closeAboutModal() {
    const modal = document.getElementById('aboutModal');
    modal.classList.remove('show');
    isModalOpen = false;
    document.body.style.overflow = '';
}

function openHistoryModal() {
    closeModal();
    closeEditModal();

    const modal = document.getElementById('historyModal');
    modal.classList.add('show');
    loadUserBookings();
}

function closeHistoryModal() {
    const modal = document.getElementById('historyModal');
    modal.classList.remove('show');
}

function openEditModal(bookingId) {
    closeModal();
    closeHistoryModal();

    const booking = userBookings.find(b => b.id === bookingId);
    if (!booking) return;

    document.getElementById('editBookingId').value = booking.id;
    document.getElementById('editSubject').value = booking.subject;
    document.getElementById('editService').value = booking.service;
    document.getElementById('editDate').value = booking.date;
    document.getElementById('editTimeInput').value = booking.time;
    document.getElementById('editComment').value = booking.comment || '';
    document.getElementById('editOriginalTime').value = booking.time;

    // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    document.getElementById('editTimeValidationMessage').textContent = '';
    document.getElementById('editTimeInput').classList.remove('input-error', 'input-success');

    const modal = document.getElementById('editModal');
    modal.classList.add('show');
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.remove('show');
}

function clearValidation() {
    document.querySelectorAll('.validation-error').forEach(el => el.remove());
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    document.querySelectorAll('.input-success').forEach(el => el.classList.remove('input-success'));
}

// User bookings functions
async function loadUserBookings() {
    const container = document.getElementById('bookingsList');
    const userData = getUserData();

    if (!userData.id) {
        container.innerHTML = '<div class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
        return;
    }

    try {
        container.innerHTML = '<div class="loading-bookings"><div class="loading-spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—à–∏—Ö –∑–∞–ø–∏—Å–µ–π...</p></div>';

        const response = await fetch(`/api/user-bookings?user_id=${userData.id}`);
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        userBookings = data;

        if (userBookings.length === 0) {
            container.innerHTML = `
                <div class="no-bookings">
                    <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
                    <p>–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø–µ—Ä–≤—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é!</p>
                </div>
            `;
            return;
        }

        let html = '';
        userBookings.forEach(booking => {
            const bookingDate = new Date(booking.date);
            const formattedDate = bookingDate.toLocaleDateString('ru-RU');
            const isPast = !booking.can_modify;

            html += `
                <div class="booking-item ${isPast ? 'past' : ''}">
                    <div class="booking-header">
                        <div class="booking-subject">${booking.subject}</div>
                        <div class="booking-service">${booking.service}</div>
                    </div>
                    <div class="booking-details">
                        <div class="booking-date">üìÖ ${formattedDate} ‚è∞ ${booking.time}</div>
                        ${booking.comment ? `<div class="booking-comment">üí¨ ${booking.comment}</div>` : ''}
                    </div>
                    ${!isPast ? `
                    <div class="booking-actions">
                        <button class="edit-btn" onclick="openEditModal(${booking.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="cancel-btn" onclick="confirmCancelBooking(${booking.id})">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                    </div>
                    ` : ''}
                </div>
            `;
        });

        container.innerHTML = html;

    } catch (error) {
        container.innerHTML = `<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
    }
}

async function updateBooking(e) {
    e.preventDefault();

    const bookingId = document.getElementById('editBookingId').value;
    const userData = getUserData();
    const timeInput = document.getElementById('editTimeInput');

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
    if (!validateTimeFormat(timeInput, 'editTimeValidationMessage')) {
        tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–ß–ß:MM)");
        return;
    }

    const formData = {
        subject: document.getElementById('editSubject').value,
        service: document.getElementById('editService').value,
        date: document.getElementById('editDate').value,
        time: timeInput.value,
        comment: document.getElementById('editComment').value
    };

    try {
        const response = await fetch('/api/update-booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: bookingId,
                user_id: userData.id,
                updates: formData
            })
        });

        const result = await response.json();

        if (result.status === 'success') {
            tg.showPopup({
                title: "‚úÖ –£—Å–ø–µ—à–Ω–æ!",
                message: result.message,
                buttons: [{type: "ok"}]
            });
            closeEditModal();
            openHistoryModal();
        } else {
            throw new Error(result.message);
        }

    } catch (error) {
        tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: " + error.message);
    }
}

async function cancelBookingDirect(bookingId, userId) {
    try {
        const response = await fetch('/api/cancel-booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: bookingId,
                user_id: userId
            })
        });

        const result = await response.json();

        if (result.status === 'success') {
            tg.showPopup({
                title: "‚úÖ –û—Ç–º–µ–Ω–µ–Ω–æ!",
                message: result.message,
                buttons: [{type: "ok"}]
            });
            loadUserBookings();
            closeEditModal();
        } else {
            throw new Error(result.message);
        }

    } catch (error) {
        tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ: " + error.message);
    }
}

function getUserData() {
    if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
        tg.showAlert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ –±–æ—Ç–∞.");
        return { id: null };
    }
    return {
        id: tg.initDataUnsafe.user.id,
        first_name: tg.initDataUnsafe.user.first_name || '',
        last_name: tg.initDataUnsafe.user.last_name || '',
        username: tg.initDataUnsafe.user.username || ''
    };
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
function validateTimeFormat(input, validationMessageId = 'timeValidationMessage') {
    const validationMessage = document.getElementById(validationMessageId);
    const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;

    if (!input.value) {
        validationMessage.textContent = '';
        input.classList.remove('input-error', 'input-success');
        return false;
    }

    if (timePattern.test(input.value)) {
        validationMessage.textContent = '‚úì –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç';
        validationMessage.style.color = '#28a745';
        input.classList.remove('input-error');
        input.classList.add('input-success');
        return true;
    } else {
        validationMessage.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ß–ß:MM (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14:30)';
        validationMessage.style.color = '#dc3545';
        input.classList.remove('input-success');
        input.classList.add('input-error');
        return false;
    }
}

// Form validation and submission
function setupRealTimeValidation() {
    document.getElementById('subject').addEventListener('blur', function(e) {
        validateSubject(e.target.value);
    });

    document.getElementById('date').addEventListener('change', function(e) {
        validateDate(e.target.value);
    });

    document.getElementById('service').addEventListener('change', function(e) {
        validateService(e.target.value);
    });

    document.getElementById('timeInput').addEventListener('input', function(e) {
        validateTimeFormat(e.target);
    });

    document.getElementById('editTimeInput').addEventListener('input', function(e) {
        validateTimeFormat(e.target, 'editTimeValidationMessage');
    });
}

function validateSubject(value) {
    const subjectGroup = document.getElementById('subject').closest('.form-group');
    const input = document.getElementById('subject');

    if (!value.trim()) {
        showError(subjectGroup, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç');
        input.classList.add('input-error');
        return false;
    }

    if (value.length < 2) {
        showError(subjectGroup, '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ');
        input.classList.add('input-error');
        return false;
    }

    clearError(subjectGroup);
    input.classList.remove('input-error');
    input.classList.add('input-success');
    return true;
}

function validateDate(dateString) {
    const dateGroup = document.getElementById('date').closest('.form-group');
    const input = document.getElementById('date');

    if (!dateString) {
        clearError(dateGroup);
        input.classList.remove('input-error');
        return false;
    }

    const selectedDate = new Date(dateString);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (selectedDate < today) {
        showError(dateGroup, '–ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ—à–µ–¥—à—É—é –¥–∞—Ç—É');
        input.classList.add('input-error');
        return false;
    }

    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 30);

    if (selectedDate > maxDate) {
        showError(dateGroup, '–ó–∞–ø–∏—Å—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ 30 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥');
        input.classList.add('input-error');
        return false;
    }

    clearError(dateGroup);
    input.classList.remove('input-error');
    input.classList.add('input-success');
    return true;
}

function validateService(value) {
    const serviceGroup = document.getElementById('service').closest('.form-group');
    const input = document.getElementById('service');

    if (!value) {
        showError(serviceGroup, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å–ª—É–≥–∏');
        input.classList.add('input-error');
        return false;
    }

    clearError(serviceGroup);
    input.classList.remove('input-error');
    input.classList.add('input-success');
    return true;
}

function showError(formGroup, message) {
    clearError(formGroup);
    const errorDiv = document.createElement('div');
    errorDiv.className = 'validation-error';
    errorDiv.textContent = message;
    formGroup.appendChild(errorDiv);
}

function clearError(formGroup) {
    const errorElement = formGroup.querySelector('.validation-error');
    if (errorElement) {
        errorElement.remove();
    }
}

document.getElementById('bookingForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const isSubjectValid = validateSubject(document.getElementById('subject').value);
    const isDateValid = validateDate(document.getElementById('date').value);
    const isServiceValid = validateService(document.getElementById('service').value);
    const isTimeValid = validateTimeFormat(document.getElementById('timeInput'));

    if (!isSubjectValid || !isDateValid || !isServiceValid || !isTimeValid) {
        tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
        return;
    }

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';

    const formData = {
        subject: document.getElementById('subject').value,
        service: document.getElementById('service').value,
        date: document.getElementById('date').value,
        time: document.getElementById('timeInput').value,
        comment: document.getElementById('comment').value
    };

    try {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        const timeValidationResponse = await fetch('/api/validate-time', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                time: formData.time,
                date: formData.date
            })
        });

        const timeValidationResult = await timeValidationResponse.json();
        if (!timeValidationResult.valid) {
            throw new Error(timeValidationResult.error);
        }

        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

        const userData = getUserData();

        const response = await fetch('/api/book', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user: userData,
                booking: formData
            })
        });

        const result = await response.json();

        if (result.success) {
            tg.showPopup({
                title: "‚úÖ –£—Å–ø–µ—à–Ω–æ!",
                message: "–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
                buttons: [{type: "ok"}]
            });
            closeModal();
        } else {
            throw new Error(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏");
        }

    } catch (error) {
        tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏: " + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è';
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupRealTimeValidation();

    // Add backdrop click handlers
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
    backdrop.addEventListener('click', function(e) {
        if (e.target === this) {
            const modal = this.closest('.modal');
            modal.classList.remove('show');
            isModalOpen = false;
            document.body.style.overflow = '';
        }
    });
});

    // Edit form handler
    document.getElementById('editForm').addEventListener('submit', updateBooking);

    if (tg && tg.ready) tg.ready();
});

function confirmCancelBooking(bookingId) {
    pendingCancelId = bookingId;
    tg.showPopup({
        title: "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?",
        message: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?",
        buttons: [
            {id: "confirm_cancel", type: "destructive", text: "–î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å"},
            {type: "cancel"}
        ]
    });
}

function triggerCancelFromEdit() {
    const id = document.getElementById('editBookingId').value;
    confirmCancelBooking(Number(id));
}
console.log('Script loaded!');

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ñ–æ—Ä–º–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
const form = document.getElementById('bookingForm');
if (form) {
    console.log('Form found!');
    form.addEventListener('submit', function(e) {
        console.log('Form submitted!');
        e.preventDefault(); // –í–∞–∂–Ω–æ!
        // ... –≤–∞—à –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    });
} else {
    console.log('Form not found!');
}
</script>
</body>
</html>
